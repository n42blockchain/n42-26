# 开发日志-09：版本化顺序读取流格式重构

> 日期：2026-02-20
> 阶段：移动验证数据包协议 V2

---

## 设计决策

### 核心洞察

同一区块、同样交易 → revm `Database::basic()`/`storage()`/`block_hash()` 调用顺序 **100% 确定性**。JournaledState 缓存首次读取 → 流只需首次读取值。因此可以去掉所有 address/slot key，只保留有序值流。

### 方案选择

| 考虑方案 | 优点 | 缺点 | 决定 |
|----------|------|------|------|
| 当前 bincode(VerificationPacket) | 成熟 | 含冗余 key、需 preimage、需 pre-state fixup | 保留但不再使用 |
| Protobuf/FlatBuffers | 标准化 | 额外依赖、对齐流反而增加开销 | 放弃 |
| **自定义紧凑二进制流** | 极简、零 key、条件字段、版本化 | 需自行维护编解码 | **采用** |

### 关键设计：ReadLogDatabase 直接捕获 pre-state

旧流程：execute → capture POST-state witness → fix_witness_pre_state（查询父状态修正）
新流程：ReadLogDatabase 包装 parent state DB → execute → log 捕获的就是 pre-state → 无需修正

这消除了 `fix_witness_pre_state` 和 `packet_builder`（preimage 解析）两个复杂模块。

---

## 实施细节

### Wire Format Header（4B 共用头）

```
magic(0x4E32 "N2") + version(0x01) + flags(1B)
```

应用于 StreamPacket、CacheSyncMessage、VerificationReceipt 三种消息。

### 新模块/文件

| 文件 | 功能 |
|------|------|
| `n42-mobile/src/wire.rs` | Wire 头部编解码、WireError |
| `n42-execution/src/read_log.rs` | ReadLogEntry 枚举、ReadLogDatabase wrapper、encode/decode |
| `n42-mobile/src/packet.rs` (新增) | StreamPacket 结构、encode_stream_packet/decode_stream_packet |
| `n42-mobile/src/verifier.rs` (新增) | StreamReplayDB + verify_block_stream |
| `n42-mobile/src/code_cache.rs` (新增) | encode_cache_sync/decode_cache_sync |
| `n42-mobile/src/receipt.rs` (新增) | encode_receipt/decode_receipt |

### ReadLogDatabase (`n42-execution/src/read_log.rs`)

- 包装任意 `Database`，用 `Arc<Mutex<Vec<ReadLogEntry>>>` 捕获读取日志
- `basic()` → 记录 Account/AccountNotFound + 捕获 bytecode
- `storage()` → 记录 Storage(value)
- `block_hash()` → 记录 BlockHash(hash)
- `code_by_hash()` → **不记录**（bytecodes 走独立通道）

### StreamReplayDB (`n42-mobile/src/verifier.rs`)

- 顺序消费 ReadLogEntry，忽略 address/slot/number 参数
- `code_by_hash()` 从 bytecodes HashMap 查找，不消费 cursor
- fail-safe：如果执行顺序不一致 → 返回错误值 → receipts_root 不匹配

### ReadLogEntry 紧凑编码

| Entry | 编码 |
|-------|------|
| AccountNotFound | tag(0x00) + data_len(0) |
| EOA(nonce=0, balance=0) | tag(0x01) + data_len(1) + flags(0x00) → **仅 4 字节** |
| EOA(有值) | tag(0x01) + flags + 条件 nonce(8B) + 条件 balance(32B) |
| Contract | tag(0x02) + flags + 条件字段 + code_hash(32B) |
| Storage | tag(0x03) + value(32B) |
| BlockHash | tag(0x04) + hash(32B) |

### IDC 端集成（`n42-node/src/mobile_packet.rs`）

- `generate_and_broadcast_v2()`：ReadLogDatabase → execute → 提取 log + codes → StreamPacket → zstd → broadcast
- CacheSyncMessage 使用 `encode_cache_sync()` 替代 `bincode::serialize`
- 移除对 `packet_builder`、`fix_witness_pre_state`、`execute_block_with_witness` 的依赖

---

## 遇到的问题及解决方案

1. **`alloy_evm::Database` vs `revm::Database`**：reth 的 executor 要求 `alloy_evm::Database`，它在 `revm::Database` 基础上额外要求 `Debug` 和 `Error: std::error::Error + Send + Sync + 'static`。解决：为 ReadLogDatabase 和 StreamReplayDB 添加 `#[derive(Debug)]`，为 StreamDbError 使用 `thiserror::Error`。

2. **`StorageKey` 类型差异**：`revm::primitives::StorageKey` 是 `U256`，而 `alloy_primitives::StorageKey` 是 `B256`。解决：明确使用 `revm::primitives::StorageKey`。

3. **Arc::try_unwrap 类型推断**：executor 消费 DB 后通过 Arc 恢复日志数据。`unwrap_or_else` 的 clone 返回值类型需要与 Mutex 匹配。解决：使用 match 模式替代 unwrap_or_else。

4. **n42-execution 缺少 thiserror**：为 DecodeError 添加 thiserror derive 时发现 Cargo.toml 未列出此依赖。解决：添加 `thiserror.workspace = true`。

---

## 阶段完成状态

- [x] Step A: Wire Format 基础模块（wire.rs、versioned encode/decode for CacheSync/Receipt）
- [x] Step B: ReadLogDatabase + encode/decode（read_log.rs）
- [x] Step C: StreamPacket 编解码（packet.rs 新增）
- [x] Step D: StreamReplayDB + verify_block_stream（verifier.rs 新增）
- [x] Step E: IDC 端集成（mobile_packet.rs 重写为 V2）
- [x] Step F: 全量编译 + 212 个测试通过

### 测试覆盖

| 包 | 通过测试数 |
|----|-----------|
| n42-execution | 48 |
| n42-mobile | 77 |
| n42-node | 87 |
| **总计** | **212** |

---

## 后续计划

1. **删除旧代码**：`packet_builder.rs` 不再被 mobile_packet.rs 使用，可在确认无其他引用后删除
2. **旧格式兼容**：目前保留了 VerificationPacket 和 verify_block()，后续版本可移除
3. **集成测试**：在真实链上验证 IDC → phone 全链路，确认 stream 回放产生相同 receipts_root
4. **性能基准**：对比新旧格式的编码大小和 zstd 压缩比
5. **版本协商**：支持 phone 通告能力版本，IDC 按能力选择发送 V1 或 V2
