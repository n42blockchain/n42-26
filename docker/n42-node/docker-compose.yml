# N42 3-Node Local Test Cluster
#
# SECURITY WARNING: The validator keys below are deterministic dev-only keys.
# NEVER use these keys in production. Generate proper keys with n42-keygen.
#
# Usage:
#   # Build (context must include both n42-26/ and reth/ directories):
#   docker compose -f docker/n42-node/docker-compose.yml build
#
#   # Start the cluster:
#   docker compose -f docker/n42-node/docker-compose.yml up
#
#   # Check consensus status:
#   curl -s http://localhost:8545 -X POST \
#     -H "Content-Type: application/json" \
#     -d '{"jsonrpc":"2.0","method":"n42_consensusStatus","params":[],"id":1}'
#
# All three nodes use deterministic dev keys and mDNS for automatic peer
# discovery on the Docker bridge network.

x-n42-common: &n42-common
  build:
    context: ../../..
    dockerfile: n42-26/docker/n42-node/Dockerfile
  restart: unless-stopped
  environment: &n42-env
    N42_VALIDATOR_COUNT: "3"
    N42_ENABLE_MDNS: "true"
    N42_DATA_DIR: "/data/n42"
    RUST_LOG: "info,n42=debug"

services:
  node-0:
    <<: *n42-common
    container_name: n42-node-0
    environment:
      <<: *n42-env
      # DEV ONLY — deterministic key for local testing
      N42_VALIDATOR_KEY: "0000000000000000000000000000000000000000000000000000000000000001"
    ports:
      - "8545:8545"   # HTTP RPC
      - "9400:9400/udp" # Consensus P2P
      - "9443:9443/udp" # Mobile StarHub
      - "9001:9001"     # Prometheus metrics
    volumes:
      - node0-data:/data/n42
    command: ["--http", "--http.addr", "0.0.0.0", "--metrics", "0.0.0.0:9001"]

  node-1:
    <<: *n42-common
    container_name: n42-node-1
    environment:
      <<: *n42-env
      # DEV ONLY — deterministic key for local testing
      N42_VALIDATOR_KEY: "0000000000000000000000000000000000000000000000000000000000000002"
      N42_CONSENSUS_PORT: "9401"
      N42_STARHUB_PORT: "9444"
    ports:
      - "8546:8545"
      - "9401:9401/udp"
      - "9444:9444/udp"
      - "9002:9001"
    volumes:
      - node1-data:/data/n42
    command: ["--http", "--http.addr", "0.0.0.0", "--http.port", "8545", "--metrics", "0.0.0.0:9001"]

  node-2:
    <<: *n42-common
    container_name: n42-node-2
    environment:
      <<: *n42-env
      # DEV ONLY — deterministic key for local testing
      N42_VALIDATOR_KEY: "0000000000000000000000000000000000000000000000000000000000000003"
      N42_CONSENSUS_PORT: "9402"
      N42_STARHUB_PORT: "9445"
    ports:
      - "8547:8545"
      - "9402:9402/udp"
      - "9445:9445/udp"
      - "9003:9001"
    volumes:
      - node2-data:/data/n42
    command: ["--http", "--http.addr", "0.0.0.0", "--http.port", "8545", "--metrics", "0.0.0.0:9001"]

volumes:
  node0-data:
  node1-data:
  node2-data:
